<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Wavee.UI.WinUI.Views.ArtistsLibraryPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:Wavee.UI.WinUI.Controls"
    xmlns:tracklist="using:Wavee.UI.WinUI.Controls.TrackList"
    xmlns:dto="using:Wavee.UI.WinUI.Data.DTOs"
    xmlns:vm="using:Wavee.UI.WinUI.ViewModels"
    xmlns:primitives="using:CommunityToolkit.WinUI.Controls"
    xmlns:toolkit="using:CommunityToolkit.WinUI"
    xmlns:media="using:CommunityToolkit.WinUI.Media"
    xmlns:behaviors="using:Wavee.UI.WinUI.Behaviors"
    mc:Ignorable="d"
    NavigationCacheMode="Enabled"
    Background="Transparent">

    <Page.Resources>
        <media:AttachedCardShadow x:Key="CardShadow"
                                   Offset="4"
                                   BlurRadius="16"
                                   Opacity="0.25"
                                   CornerRadius="8"/>
    </Page.Resources>

    <Grid x:Name="RootGrid">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280" MinWidth="200" MaxWidth="400"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition x:Name="TracksPanelColumn" Width="0"/>
        </Grid.ColumnDefinitions>

        <!-- Left Column: Artist List -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Search Box -->
            <TextBox
                Grid.Row="0"
                PlaceholderText="Filter artists..."
                Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                Margin="0,0,0,12"/>

            <!-- Artist List -->
            <ItemsView
                x:Name="ArtistsView"
                Grid.Row="1"
                ItemsSource="{x:Bind ViewModel.FilteredArtists, Mode=OneWay}"
                SelectionMode="Single"
                SelectionChanged="ArtistsView_SelectionChanged">
                <ItemsView.Layout>
                    <StackLayout Orientation="Vertical" Spacing="2"/>
                </ItemsView.Layout>
                <ItemsView.ItemTemplate>
                    <DataTemplate x:DataType="dto:LibraryArtistDto">
                        <ItemContainer>
                            <Grid Padding="8" ColumnSpacing="12" CornerRadius="4">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="48"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Circular Artist Image -->
                                <Grid
                                    Grid.Column="0"
                                    Width="48"
                                    Height="48"
                                    CornerRadius="24"
                                    Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                                    <FontIcon
                                        Glyph="&#xE77B;"
                                        FontSize="20"
                                        Opacity="0.3"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Visibility="{x:Bind ImageUrl, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                                    <primitives:ConstrainedBox AspectRatio="1:1">
                                        <Grid CornerRadius="24">
                                            <Image
                                                Source="{x:Bind ImageUrl, Converter={StaticResource StringToImageSourceConverter}}"
                                                Stretch="UniformToFill"
                                                Visibility="{x:Bind ImageUrl, Converter={StaticResource NullToVisibilityConverter}}"
                                                behaviors:ImageFallbackBehavior.HideOnError="True"
                                                behaviors:ImageFallbackBehavior.FadeInOnLoad="True"
                                                behaviors:ImageFallbackBehavior.DecodePixelWidth="96"/>
                                        </Grid>
                                    </primitives:ConstrainedBox>
                                </Grid>

                                <!-- Name + Followers -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                    <TextBlock
                                        Text="{x:Bind Name}"
                                        Style="{StaticResource BodyStrongTextBlockStyle}"
                                        TextTrimming="CharacterEllipsis"
                                        MaxLines="1"/>
                                    <TextBlock
                                        Text="{x:Bind FollowerCountFormatted}"
                                        Style="{StaticResource CaptionTextBlockStyle}"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                        TextTrimming="CharacterEllipsis"
                                        MaxLines="1"/>
                                </StackPanel>
                            </Grid>
                        </ItemContainer>
                    </DataTemplate>
                </ItemsView.ItemTemplate>
            </ItemsView>

            <!-- Loading Shimmer -->
            <StackPanel
                Grid.Row="1"
                Spacing="2"
                Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                <!-- Skeleton artist rows -->
                <Grid Padding="8" ColumnSpacing="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <controls:Shimmer Width="48" Height="48" CornerRadius="24"/>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="6">
                        <controls:Shimmer Height="16" HorizontalAlignment="Left" Width="120"/>
                        <controls:Shimmer Height="12" HorizontalAlignment="Left" Width="80"/>
                    </StackPanel>
                </Grid>
                <Grid Padding="8" ColumnSpacing="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <controls:Shimmer Width="48" Height="48" CornerRadius="24"/>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="6">
                        <controls:Shimmer Height="16" HorizontalAlignment="Left" Width="140"/>
                        <controls:Shimmer Height="12" HorizontalAlignment="Left" Width="70"/>
                    </StackPanel>
                </Grid>
                <Grid Padding="8" ColumnSpacing="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <controls:Shimmer Width="48" Height="48" CornerRadius="24"/>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="6">
                        <controls:Shimmer Height="16" HorizontalAlignment="Left" Width="100"/>
                        <controls:Shimmer Height="12" HorizontalAlignment="Left" Width="90"/>
                    </StackPanel>
                </Grid>
                <Grid Padding="8" ColumnSpacing="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <controls:Shimmer Width="48" Height="48" CornerRadius="24"/>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="6">
                        <controls:Shimmer Height="16" HorizontalAlignment="Left" Width="130"/>
                        <controls:Shimmer Height="12" HorizontalAlignment="Left" Width="85"/>
                    </StackPanel>
                </Grid>
                <Grid Padding="8" ColumnSpacing="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <controls:Shimmer Width="48" Height="48" CornerRadius="24"/>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="6">
                        <controls:Shimmer Height="16" HorizontalAlignment="Left" Width="110"/>
                        <controls:Shimmer Height="12" HorizontalAlignment="Left" Width="75"/>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </Grid>

        <!-- Grid Splitter -->
        <controls:GridSplitter
            Grid.Column="1"
            Width="12"/>

        <!-- Right Column: Detail Panel (Elevated Card) -->
        <Border Grid.Column="2"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8"
                toolkit:Effects.Shadow="{StaticResource CardShadow}">
            <Grid Padding="12">
                <!-- Empty State -->
                <StackPanel
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Spacing="12"
                Visibility="{x:Bind ViewModel.SelectedArtist, Mode=OneWay, Converter={StaticResource InverseNullToVisibilityConverter}}">
                    <FontIcon Glyph="&#xE77B;" FontSize="48" Opacity="0.3"/>
                    <TextBlock
                    Text="Select an artist to see details"
                    Style="{StaticResource BodyTextBlockStyle}"
                    Opacity="0.5"
                    TextAlignment="Center"/>
                </StackPanel>

                <!-- Detail Content -->
                <Grid Visibility="{x:Bind ViewModel.SelectedArtist, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Grid Grid.Row="0" Margin="0,0,0,16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Artist Image -->
                        <Grid
                        Grid.Column="0"
                        Width="80"
                        Height="80"
                        CornerRadius="40"
                        Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                            <FontIcon
                            Glyph="&#xE77B;"
                            FontSize="32"
                            Opacity="0.3"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Visibility="{x:Bind ViewModel.SelectedArtistImageUrl, Mode=OneWay, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                            <Image
                            Source="{x:Bind ViewModel.SelectedArtistImageUrl, Mode=OneWay, Converter={StaticResource StringToImageSourceConverter}}"
                            Stretch="UniformToFill"
                            Visibility="{x:Bind ViewModel.SelectedArtistImageUrl, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
                            behaviors:ImageFallbackBehavior.HideOnError="True"
                            behaviors:ImageFallbackBehavior.FadeInOnLoad="True"
                            behaviors:ImageFallbackBehavior.DecodePixelWidth="160"/>
                        </Grid>

                        <!-- Artist Info -->
                        <StackPanel Grid.Column="1" Margin="12,0,0,0" Spacing="4" VerticalAlignment="Center">
                            <TextBlock
                            Text="{x:Bind ViewModel.SelectedArtistName, Mode=OneWay}"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            TextTrimming="CharacterEllipsis"
                            MaxLines="2"/>
                            <TextBlock
                            Text="{x:Bind ViewModel.SelectedArtistFollowers, Mode=OneWay}"
                            Style="{StaticResource CaptionTextBlockStyle}"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                            <!-- Action buttons -->
                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                <Button
                                Style="{StaticResource AccentButtonStyle}"
                                Command="{x:Bind ViewModel.PlayArtistCommand}"
                                Padding="12,6">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <FontIcon Glyph="&#xE768;" FontSize="14"/>
                                        <TextBlock Text="Play"/>
                                    </StackPanel>
                                </Button>
                                <Button
                                Command="{x:Bind ViewModel.ShuffleArtistCommand}"
                                Padding="12,6">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <FontIcon Glyph="&#xE8B1;" FontSize="14"/>
                                        <TextBlock Text="Shuffle"/>
                                    </StackPanel>
                                </Button>
                                <Button
                                Command="{x:Bind ViewModel.OpenArtistDetailsCommand}"
                                Padding="12,6">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <FontIcon Glyph="&#xE7B3;" FontSize="14"/>
                                        <TextBlock Text="View artist"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </Grid>

                    <!-- Scrollable content: Grouped Albums -->
                    <ScrollView Grid.Row="1">
                        <ItemsRepeater ItemsSource="{x:Bind ViewModel.AlbumGroups, Mode=OneWay}">
                            <ItemsRepeater.Layout>
                                <StackLayout Orientation="Vertical" Spacing="24"/>
                            </ItemsRepeater.Layout>
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate x:DataType="vm:ArtistAlbumGroupViewModel">
                                    <StackPanel>
                                        <!-- Group Header with Toggle -->
                                        <Grid Margin="0,0,0,12">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock
                                            Grid.Column="0"
                                            Text="{x:Bind GroupName}"
                                            Style="{StaticResource BodyStrongTextBlockStyle}"
                                            VerticalAlignment="Center"/>

                                            <!-- View Mode Toggle -->
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                                                <Button
                                                Padding="8,4"
                                                Background="{x:Bind IsListView, Mode=OneWay, Converter={StaticResource InverseBoolToBackgroundConverter}}"
                                                Command="{x:Bind ToggleViewModeCommand}"
                                                ToolTipService.ToolTip="Grid view">
                                                    <FontIcon Glyph="&#xF0E2;" FontSize="14"/>
                                                </Button>
                                                <Button
                                                Padding="8,4"
                                                Background="{x:Bind IsListView, Mode=OneWay, Converter={StaticResource BoolToBackgroundConverter}}"
                                                Command="{x:Bind ToggleViewModeCommand}"
                                                ToolTipService.ToolTip="List view">
                                                    <FontIcon Glyph="&#xE8FD;" FontSize="14"/>
                                                </Button>
                                            </StackPanel>
                                        </Grid>

                                        <!-- Grid View (Album Cards) -->
                                        <ItemsView
                                        ItemsSource="{x:Bind Albums}"
                                        SelectionMode="Single"
                                        Visibility="{x:Bind IsListView, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                            <ItemsView.Layout>
                                                <StackLayout Orientation="Horizontal" Spacing="12"/>
                                            </ItemsView.Layout>
                                            <ItemsView.ItemTemplate>
                                                <DataTemplate x:DataType="vm:ArtistAlbumItemViewModel">
                                                    <ItemContainer>
                                                        <Grid Width="120" RowSpacing="6" Padding="4"
                                                          Tapped="{x:Bind OnTapped}">
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="120"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <Border
                                                            Grid.Row="0"
                                                            CornerRadius="6"
                                                            Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                                                                <Grid>
                                                                    <FontIcon
                                                                    Glyph="&#xE93C;"
                                                                    FontSize="32"
                                                                    Opacity="0.3"
                                                                    Visibility="{x:Bind Album.ImageUrl, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                                                                    <Image
                                                                    Source="{x:Bind Album.ImageUrl, Converter={StaticResource StringToImageSourceConverter}}"
                                                                    Stretch="UniformToFill"
                                                                    Visibility="{x:Bind Album.ImageUrl, Converter={StaticResource NullToVisibilityConverter}}"
                                                                    behaviors:ImageFallbackBehavior.HideOnError="True"
                                                                    behaviors:ImageFallbackBehavior.FadeInOnLoad="True"
                                                                    behaviors:ImageFallbackBehavior.DecodePixelWidth="240"/>
                                                                </Grid>
                                                            </Border>

                                                            <TextBlock
                                                            Grid.Row="1"
                                                            Text="{x:Bind Album.Name}"
                                                            Style="{StaticResource CaptionTextBlockStyle}"
                                                            TextTrimming="CharacterEllipsis"
                                                            MaxLines="2"/>

                                                            <TextBlock
                                                            Grid.Row="2"
                                                            Text="{x:Bind Album.Year}"
                                                            Style="{StaticResource CaptionTextBlockStyle}"
                                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                        </Grid>
                                                    </ItemContainer>
                                                </DataTemplate>
                                            </ItemsView.ItemTemplate>
                                        </ItemsView>

                                        <!-- List View (Albums with Tracks) -->
                                        <ItemsRepeater
                                        ItemsSource="{x:Bind Albums}"
                                        Visibility="{x:Bind IsListView, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <ItemsRepeater.Layout>
                                                <StackLayout Orientation="Vertical" Spacing="16"/>
                                            </ItemsRepeater.Layout>
                                            <ItemsRepeater.ItemTemplate>
                                                <DataTemplate x:DataType="vm:ArtistAlbumItemViewModel">
                                                    <StackPanel>
                                                        <!-- Album Header -->
                                                        <Grid ColumnSpacing="12" Margin="0,0,0,8">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="48"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>

                                                            <Border
                                                            Grid.Column="0"
                                                            Width="48"
                                                            Height="48"
                                                            CornerRadius="4"
                                                            Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                                                                <Grid>
                                                                    <FontIcon
                                                                    Glyph="&#xE93C;"
                                                                    FontSize="20"
                                                                    Opacity="0.3"
                                                                    Visibility="{x:Bind Album.ImageUrl, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                                                                    <Image
                                                                    Source="{x:Bind Album.ImageUrl, Converter={StaticResource StringToImageSourceConverter}}"
                                                                    Stretch="UniformToFill"
                                                                    Visibility="{x:Bind Album.ImageUrl, Converter={StaticResource NullToVisibilityConverter}}"
                                                                    behaviors:ImageFallbackBehavior.HideOnError="True"
                                                                    behaviors:ImageFallbackBehavior.FadeInOnLoad="True"
                                                                    behaviors:ImageFallbackBehavior.DecodePixelWidth="96"/>
                                                                </Grid>
                                                            </Border>

                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                                                <TextBlock
                                                                Text="{x:Bind Album.Name}"
                                                                Style="{StaticResource BodyStrongTextBlockStyle}"
                                                                TextTrimming="CharacterEllipsis"/>
                                                                <TextBlock
                                                                Text="{x:Bind Album.Year}"
                                                                Style="{StaticResource CaptionTextBlockStyle}"
                                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                            </StackPanel>
                                                        </Grid>

                                                        <!-- Shimmer Loading State -->
                                                        <StackPanel
                                                        Visibility="{x:Bind IsLoadingTracks, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                                        Spacing="8"
                                                        Margin="0,0,0,8">
                                                            <Grid Height="32" ColumnSpacing="12">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="24"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="40"/>
                                                                </Grid.ColumnDefinitions>
                                                                <controls:Shimmer Grid.Column="0"/>
                                                                <controls:Shimmer Grid.Column="1"/>
                                                                <controls:Shimmer Grid.Column="2"/>
                                                            </Grid>
                                                            <Grid Height="32" ColumnSpacing="12">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="24"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="40"/>
                                                                </Grid.ColumnDefinitions>
                                                                <controls:Shimmer Grid.Column="0"/>
                                                                <controls:Shimmer Grid.Column="1"/>
                                                                <controls:Shimmer Grid.Column="2"/>
                                                            </Grid>
                                                            <Grid Height="32" ColumnSpacing="12">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="24"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="40"/>
                                                                </Grid.ColumnDefinitions>
                                                                <controls:Shimmer Grid.Column="0"/>
                                                                <controls:Shimmer Grid.Column="1"/>
                                                                <controls:Shimmer Grid.Column="2"/>
                                                            </Grid>
                                                        </StackPanel>

                                                        <!-- Tracks List -->
                                                        <ItemsRepeater
                                                        ItemsSource="{x:Bind Tracks, Mode=OneWay}"
                                                        Visibility="{x:Bind HasLoadedTracks, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                                            <ItemsRepeater.Layout>
                                                                <StackLayout Orientation="Vertical" Spacing="4"/>
                                                            </ItemsRepeater.Layout>
                                                            <ItemsRepeater.ItemTemplate>
                                                                <DataTemplate x:DataType="dto:AlbumTrackDto">
                                                                    <Grid
                                                                    Padding="8,6"
                                                                    ColumnSpacing="12"
                                                                    Background="Transparent"
                                                                    CornerRadius="4">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="24"/>
                                                                            <ColumnDefinition Width="*"/>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                        </Grid.ColumnDefinitions>

                                                                        <!-- Track Number -->
                                                                        <TextBlock
                                                                        Grid.Column="0"
                                                                        Text="{x:Bind TrackNumber}"
                                                                        Style="{StaticResource CaptionTextBlockStyle}"
                                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"/>

                                                                        <!-- Track Title -->
                                                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                                                                            <TextBlock
                                                                            Text="{x:Bind Title}"
                                                                            Style="{StaticResource BodyTextBlockStyle}"
                                                                            TextTrimming="CharacterEllipsis"/>
                                                                            <Border
                                                                            Visibility="{x:Bind IsExplicit, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                            Background="{ThemeResource TextFillColorSecondaryBrush}"
                                                                            CornerRadius="2"
                                                                            Padding="4,1">
                                                                                <TextBlock
                                                                                Text="E"
                                                                                FontSize="10"
                                                                                FontWeight="Bold"
                                                                                Foreground="{ThemeResource SolidBackgroundFillColorBaseBrush}"/>
                                                                            </Border>
                                                                        </StackPanel>

                                                                        <!-- Duration -->
                                                                        <TextBlock
                                                                        Grid.Column="2"
                                                                        Text="{x:Bind DurationFormatted}"
                                                                        Style="{StaticResource CaptionTextBlockStyle}"
                                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                        VerticalAlignment="Center"/>
                                                                    </Grid>
                                                                </DataTemplate>
                                                            </ItemsRepeater.ItemTemplate>
                                                        </ItemsRepeater>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsRepeater.ItemTemplate>
                                        </ItemsRepeater>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </ScrollView>

                    <!-- Loading Shimmer for Details -->
                    <StackPanel
                    Grid.Row="1"
                    Visibility="{x:Bind ViewModel.IsLoadingDetails, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                    Spacing="24">
                        <!-- Album Group Shimmer -->
                        <StackPanel Spacing="12">
                            <controls:Shimmer Height="20" Width="80" HorizontalAlignment="Left"/>
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <StackPanel Width="120" Spacing="6">
                                    <controls:Shimmer Height="120" CornerRadius="6"/>
                                    <controls:Shimmer Height="14" Width="100"/>
                                    <controls:Shimmer Height="12" Width="50"/>
                                </StackPanel>
                                <StackPanel Width="120" Spacing="6">
                                    <controls:Shimmer Height="120" CornerRadius="6"/>
                                    <controls:Shimmer Height="14" Width="90"/>
                                    <controls:Shimmer Height="12" Width="50"/>
                                </StackPanel>
                                <StackPanel Width="120" Spacing="6">
                                    <controls:Shimmer Height="120" CornerRadius="6"/>
                                    <controls:Shimmer Height="14" Width="110"/>
                                    <controls:Shimmer Height="12" Width="50"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                        <!-- Second Album Group Shimmer -->
                        <StackPanel Spacing="12">
                            <controls:Shimmer Height="20" Width="100" HorizontalAlignment="Left"/>
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <StackPanel Width="120" Spacing="6">
                                    <controls:Shimmer Height="120" CornerRadius="6"/>
                                    <controls:Shimmer Height="14" Width="85"/>
                                    <controls:Shimmer Height="12" Width="50"/>
                                </StackPanel>
                                <StackPanel Width="120" Spacing="6">
                                    <controls:Shimmer Height="120" CornerRadius="6"/>
                                    <controls:Shimmer Height="14" Width="105"/>
                                    <controls:Shimmer Height="12" Width="50"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>

        <!-- Second Grid Splitter (visible when tracks panel open) -->
        <controls:GridSplitter
            Grid.Column="3"
            Width="12"
            Visibility="{x:Bind ViewModel.IsTracksPanelVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

        <!-- Third Column: Album Tracks Panel (Topmost Card) -->
        <Border x:Name="TracksPanelBorder"
                Grid.Column="4"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8"
                toolkit:Effects.Shadow="{StaticResource CardShadow}"
                MinWidth="280">
            <Grid x:Name="TracksPanel" Padding="12">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Album Header with Close Button -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="64"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Album Image -->
                    <Border
                    Grid.Column="0"
                    Width="64"
                    Height="64"
                    CornerRadius="6"
                    Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                        <Grid>
                            <FontIcon
                            Glyph="&#xE93C;"
                            FontSize="24"
                            Opacity="0.3"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Visibility="{x:Bind ViewModel.SelectedAlbumImageUrl, Mode=OneWay, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                            <Image
                            Source="{x:Bind ViewModel.SelectedAlbumImageUrl, Mode=OneWay, Converter={StaticResource StringToImageSourceConverter}}"
                            Stretch="UniformToFill"
                            Visibility="{x:Bind ViewModel.SelectedAlbumImageUrl, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
                            behaviors:ImageFallbackBehavior.HideOnError="True"
                            behaviors:ImageFallbackBehavior.FadeInOnLoad="True"
                            behaviors:ImageFallbackBehavior.DecodePixelWidth="128"/>
                        </Grid>
                    </Border>

                    <!-- Album Info -->
                    <StackPanel Grid.Column="1" Margin="12,0,0,0" Spacing="4" VerticalAlignment="Center">
                        <TextBlock
                        Text="{x:Bind ViewModel.SelectedAlbumName, Mode=OneWay}"
                        Style="{StaticResource BodyStrongTextBlockStyle}"
                        TextTrimming="CharacterEllipsis"
                        MaxLines="2"/>
                        <TextBlock
                        Text="{x:Bind ViewModel.SelectedAlbumYear, Mode=OneWay}"
                        Style="{StaticResource CaptionTextBlockStyle}"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <Button
                        Command="{x:Bind ViewModel.OpenSelectedAlbumCommand}"
                        Padding="8,4"
                        Margin="0,4,0,0">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <FontIcon Glyph="&#xE7B3;" FontSize="12"/>
                                <TextBlock Text="View album" Style="{StaticResource CaptionTextBlockStyle}"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Close Button -->
                    <Button
                    Grid.Column="2"
                    Command="{x:Bind ViewModel.CloseTracksPanelCommand}"
                    Style="{StaticResource SubtleButtonStyle}"
                    Padding="8"
                    VerticalAlignment="Top">
                        <FontIcon Glyph="&#xE8BB;" FontSize="12"/>
                    </Button>
                </Grid>

                <!-- Track List using TrackListView (compact mode) -->
                <tracklist:TrackListView
                Grid.Row="1"
                ViewModel="{x:Bind ViewModel}"
                ItemsSource="{x:Bind ViewModel.SelectedAlbumTracks, Mode=OneWay}"
                IsLoading="{x:Bind ViewModel.IsLoadingSelectedAlbumTracks, Mode=OneWay}"
                IsCompact="True" HorizontalAlignment="Stretch"
                ShowColumnHeaders="False"
                ShowAlbumArtColumn="False"
                ShowArtistColumn="False"
                ShowAlbumColumn="False"
                ShowDateAddedColumn="False"/>
            </Grid>
        </Border>
    </Grid>
</Page>
