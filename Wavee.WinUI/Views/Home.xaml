<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="Wavee.WinUI.Views.Home"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:animations="using:CommunityToolkit.WinUI.Animations"
    xmlns:behaviors="using:CommunityToolkit.WinUI.Behaviors"
    xmlns:components="using:Wavee.WinUI.Controls"
    xmlns:controls="using:Wavee.WinUI.Views.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="using:Wavee.WinUI.Helpers"
    xmlns:interactions="using:Microsoft.Xaml.Interactivity"
    xmlns:labs="using:CommunityToolkit.WinUI.Controls"
    xmlns:layouts="using:Wavee.WinUI.Layouts"
    xmlns:local="using:Wavee.WinUI.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:media="using:CommunityToolkit.WinUI.Media"
    xmlns:primitives="using:CommunityToolkit.WinUI.Controls"
    xmlns:selectors="using:Wavee.WinUI.Selectors"
    xmlns:ui="using:CommunityToolkit.WinUI"
    xmlns:vm="using:Wavee.WinUI.ViewModels"
    mc:Ignorable="d">

    <Page.Resources>

        <!--  Section Data Template Selector  -->
        <selectors:SectionDataTemplateSelector x:Key="SectionTemplateSelector">
            <!--  Static Section Template  -->
            <selectors:SectionDataTemplateSelector.StaticSectionTemplate>
                <DataTemplate x:DataType="vm:HomeSectionViewModel">
                    <StackPanel Margin="0,0,0,24" Spacing="16">
                        <!--  Section Header  -->
                        <StackPanel>
                            <TextBlock
                                FontSize="24"
                                FontWeight="SemiBold"
                                Text="{x:Bind Title, Mode=OneWay}" />
                            <TextBlock
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Text="{x:Bind Subtitle, Mode=OneWay}"
                                Visibility="{x:Bind Subtitle, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}" />
                        </StackPanel>

                        <!--  Content Items  -->
                        <ItemsRepeater ItemsSource="{x:Bind Items, Mode=OneWay}">
                            <ItemsRepeater.Layout>
                                <layouts:ResponsiveHorizontalLayout
                                    ItemSpacing="12"
                                    MaxItemWidth="300"
                                    MinItemWidth="180" />
                            </ItemsRepeater.Layout>
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate x:DataType="vm:ContentItemViewModel">
                                    <components:ContentCard Content="{x:Bind}" />
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </StackPanel>
                </DataTemplate>
            </selectors:SectionDataTemplateSelector.StaticSectionTemplate>

            <!--  Deferred Section Template (with loading/error states)  -->
            <selectors:SectionDataTemplateSelector.DeferredSectionTemplate>
                <DataTemplate x:DataType="vm:DeferredSectionViewModel">
                    <StackPanel Margin="0,0,0,24" Spacing="16">
                        <!--  Section Header  -->
                        <TextBlock
                            FontSize="24"
                            FontWeight="SemiBold"
                            Text="{x:Bind Title, Mode=OneWay}" />

                        <!--  Loading State  -->
                        <StackPanel Spacing="16" Visibility="{x:Bind IsLoading, Mode=OneWay}">
                            <ItemsRepeater ItemsSource="{x:Bind ShimmerCards}">
                                <ItemsRepeater.Layout>
                                    <StackLayout Orientation="Horizontal" Spacing="12" />
                                </ItemsRepeater.Layout>
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel
                                            Width="180"
                                            Padding="12"
                                            Spacing="8">
                                            <!--  Image Shimmer  -->
                                            <labs:Shimmer
                                                Width="156"
                                                Height="156"
                                                CornerRadius="4"
                                                IsActive="True" />

                                            <!--  Title Shimmer  -->
                                            <labs:Shimmer
                                                Width="140"
                                                Height="20"
                                                IsActive="True" />

                                            <!--  Subtitle Shimmer  -->
                                            <labs:Shimmer
                                                Width="100"
                                                Height="16"
                                                IsActive="True" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                        </StackPanel>

                        <!--  Error State  -->
                        <InfoBar
                            Title="Unable to load section"
                            IsOpen="{x:Bind HasError, Mode=OneWay}"
                            Message="{x:Bind ErrorMessage, Mode=OneWay}"
                            Severity="Error">
                            <InfoBar.ActionButton>
                                <Button Command="{x:Bind LoadDataCommand}" Content="Retry" />
                            </InfoBar.ActionButton>
                        </InfoBar>

                        <!--  Normal Content (when loaded)  -->
                        <ItemsRepeater ItemsSource="{x:Bind Items, Mode=OneWay}">
                            <ItemsRepeater.Layout>
                                <layouts:ResponsiveHorizontalLayout
                                    ItemSpacing="12"
                                    MaxItemWidth="300"
                                    MinItemWidth="180" />
                            </ItemsRepeater.Layout>
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate x:DataType="vm:ContentItemViewModel">
                                    <components:ContentCard Content="{x:Bind}" />
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </StackPanel>
                </DataTemplate>
            </selectors:SectionDataTemplateSelector.DeferredSectionTemplate>

            <!--  Grid Section Template (horizontal cards in wrapping grid)  -->
            <selectors:SectionDataTemplateSelector.GridSectionTemplate>
                <DataTemplate x:DataType="vm:HomeSectionViewModel">
                    <StackPanel Margin="0,0,0,24" Spacing="16">
                        <!--  Content Items in Grid Layout  -->
                        <ItemsRepeater ItemsSource="{x:Bind Items, Mode=OneWay}">
                            <ItemsRepeater.Layout>
                                <UniformGridLayout
                                    ItemsStretch="Fill"
                                    MaximumRowsOrColumns="3"
                                    MinColumnSpacing="8"
                                    MinItemHeight="80"
                                    MinRowSpacing="8"
                                    Orientation="Horizontal" />
                            </ItemsRepeater.Layout>
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate x:DataType="vm:ContentItemViewModel">
                                    <components:ShadowButton Padding="12" ShadowColor="{x:Bind ShadowColor, Mode=OneWay}">
                                        <Grid x:Name="CardRootGrid">
                                            <!--  Card Content  -->
                                            <Grid ColumnSpacing="12">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="64" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>

                                                <!--  Cover Image (Left)  -->
                                                <Border
                                                    Grid.Column="0"
                                                    Margin="-6,-12"
                                                    ui:UIElementExtensions.ClipToBounds="True"
                                                    CornerRadius="8,0,0,8">
                                                    <Image
                                                        x:Name="CardImageGrid"
                                                        Source="{x:Bind Image, Mode=OneWay}"
                                                        Stretch="UniformToFill" />
                                                </Border>

                                                <!--  Content Info (Right)  -->
                                                <StackPanel
                                                    Grid.Column="1"
                                                    VerticalAlignment="Center"
                                                    Spacing="2">
                                                    <TextBlock
                                                        FontWeight="SemiBold"
                                                        MaxLines="1"
                                                        Text="{x:Bind Name, Mode=OneWay}"
                                                        TextTrimming="CharacterEllipsis" />
                                                    <TextBlock
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                        MaxLines="1"
                                                        Text="{x:Bind Subtitle, Mode=OneWay}"
                                                        TextTrimming="CharacterEllipsis" />
                                                </StackPanel>
                                            </Grid>

                                            <!--  Hover Overlay with Buttons  -->
                                            <Grid
                                                x:Name="HoverOverlayGrid"
                                                Margin="-12"
                                                Background="Transparent"
                                                CornerRadius="8"
                                                Opacity="0">
                                                <!--  Play Button (Left/Center)  -->
                                                <Button
                                                    Margin="12,0,0,0"
                                                    HorizontalAlignment="Left"
                                                    VerticalAlignment="Center"
                                                    Command="{x:Bind PlayPauseCommand}"
                                                    Style="{StaticResource HoverPlayButtonStyle}">
                                                    <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="{x:Bind PlayPauseIcon, Mode=OneWay}" />
                                                </Button>

                                                <!--  Add Button (Right)  -->
                                                <Button
                                                    Margin="0,0,12,0"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Center"
                                                    Command="{x:Bind AddToLibraryCommand}"
                                                    Style="{StaticResource HoverIconButtonStyle}">
                                                    <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xE710;" />
                                                </Button>
                                            </Grid>
                                        </Grid>
                                    </components:ShadowButton>
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </StackPanel>
                </DataTemplate>
            </selectors:SectionDataTemplateSelector.GridSectionTemplate>

            <!--  Uniform Grid Section Template (for aggregated baseline sections)  -->
            <selectors:SectionDataTemplateSelector.UniformGridSectionTemplate>
                <DataTemplate x:DataType="vm:HomeSectionViewModel">
                    <StackPanel Margin="0,0,0,24">
                        <!--  Section Header (if title exists)  -->
                        <TextBlock
                            Margin="0,0,0,16"
                            FontSize="24"
                            FontWeight="SemiBold"
                            Text="{x:Bind Title, Mode=OneWay}"
                            Visibility="{x:Bind Title, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}" />

                        <!--  Uniform Grid of Cards  -->
                        <ItemsRepeater ItemsSource="{x:Bind Items, Mode=OneWay}">
                            <ItemsRepeater.Layout>
                                <UniformGridLayout
                                    ItemsStretch="Uniform"
                                    MinColumnSpacing="12"
                                    MinItemHeight="300"
                                    MinItemWidth="200"
                                    MinRowSpacing="12" />
                            </ItemsRepeater.Layout>

                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate x:DataType="vm:BaselineSectionCardViewModel">
                                    <StackPanel>
                                        <!--  Section Title Badge  -->
                                        <TextBlock
                                            Margin="0,0,0,4"
                                            VerticalAlignment="Bottom"
                                            FontWeight="SemiBold"
                                            Opacity=".7"
                                            Style="{ThemeResource CaptionTextBlockStyle}"
                                            Text="{x:Bind SectionTitle, Mode=OneWay}"
                                            TextTrimming="CharacterEllipsis" />

                                        <!--  Loading State  -->
                                        <Border
                                            Height="300"
                                            Padding="12"
                                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                            CornerRadius="8"
                                            Visibility="{x:Bind IsLoading, Mode=OneWay}">
                                            <StackPanel Spacing="8">
                                                <!--  Image Shimmer  -->
                                                <labs:Shimmer
                                                    Height="200"
                                                    CornerRadius="4"
                                                    IsActive="True" />

                                                <!--  Title Shimmer  -->
                                                <labs:Shimmer Height="20" IsActive="True" />

                                                <!--  Subtitle Shimmer  -->
                                                <labs:Shimmer Height="16" IsActive="True" />
                                            </StackPanel>
                                        </Border>

                                        <!--  Error State  -->
                                        <Border
                                            Height="300"
                                            Padding="12"
                                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                            BorderBrush="{ThemeResource SystemFillColorCriticalBrush}"
                                            BorderThickness="1"
                                            CornerRadius="8"
                                            Visibility="{x:Bind HasError, Mode=OneWay}">
                                            <StackPanel
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Spacing="8">
                                                <FontIcon
                                                    FontFamily="{StaticResource SymbolThemeFontFamily}"
                                                    FontSize="32"
                                                    Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                                    Glyph="&#xE7BA;" />
                                                <TextBlock
                                                    HorizontalAlignment="Center"
                                                    FontWeight="SemiBold"
                                                    Text="Failed to load"
                                                    TextAlignment="Center" />
                                                <TextBlock
                                                    HorizontalAlignment="Center"
                                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                    MaxLines="2"
                                                    Text="{x:Bind ErrorMessage, Mode=OneWay}"
                                                    TextAlignment="Center"
                                                    TextTrimming="CharacterEllipsis"
                                                    TextWrapping="Wrap" />
                                            </StackPanel>
                                        </Border>

                                        <!--  Loaded State (Normal Card)  -->
                                        <components:ShadowButton
                                            Padding="12"
                                            Command="{x:Bind NavigateCommand}"
                                            CornerRadius="8"
                                            ShadowColor="{x:Bind ShadowColor, Mode=OneWay}"
                                            Visibility="{x:Bind IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                            <StackPanel>
                                                <!--  Background with dominant color  -->
                                                <Border
                                                    Background="{x:Bind DominantColor, Mode=OneWay}"
                                                    CornerRadius="8"
                                                    Opacity="0.15" />

                                                <!--  Card Content  -->
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="*" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>

                                                    <!--  Cover Image (Full Bleed)  -->
                                                    <Border
                                                        Grid.Row="0"
                                                        Margin="{x:Bind ImageMargin, Mode=OneWay}"
                                                        ui:UIElementExtensions.ClipToBounds="True"
                                                        CornerRadius="{x:Bind ImageCornerRadius, Mode=OneWay}">
                                                        <Image Source="{x:Bind Image, Mode=OneWay}" Stretch="UniformToFill" />
                                                    </Border>

                                                    <!--  Preview Images Grid Placeholder (for future implementation)  -->
                                                    <!--  TODO: When PreviewImages are populated, display them in a 2x2 grid overlay  -->

                                                    <!--  Item Info  -->
                                                    <StackPanel Grid.Row="1" Spacing="4">
                                                        <TextBlock
                                                            FontWeight="SemiBold"
                                                            MaxLines="1"
                                                            Text="{x:Bind Name, Mode=OneWay}"
                                                            TextTrimming="CharacterEllipsis" />
                                                        <TextBlock
                                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                            MaxLines="2"
                                                            Text="{x:Bind Subtitle, Mode=OneWay}"
                                                            TextTrimming="CharacterEllipsis"
                                                            TextWrapping="Wrap"
                                                            Visibility="{x:Bind Subtitle, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}" />
                                                    </StackPanel>

                                                    <!--  Hover Overlay with Play Button  -->
                                                    <Grid
                                                        x:Name="HoverOverlay"
                                                        Grid.RowSpan="2"
                                                        Margin="{x:Bind ImageMargin, Mode=OneWay}"
                                                        Background="Transparent"
                                                        CornerRadius="{x:Bind ImageCornerRadius, Mode=OneWay}"
                                                        Opacity="0">
                                                        <!--  Play Button  -->
                                                        <Button
                                                            Margin="0,0,12,12"
                                                            HorizontalAlignment="Right"
                                                            VerticalAlignment="Bottom"
                                                            Command="{x:Bind PlayPauseCommand}"
                                                            Style="{StaticResource HoverPlayButtonStyle}">
                                                            <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="{x:Bind PlayPauseIcon, Mode=OneWay}" />
                                                        </Button>

                                                        <!--  Add Button  -->
                                                        <Button
                                                            Margin="0,12,12,0"
                                                            HorizontalAlignment="Right"
                                                            VerticalAlignment="Top"
                                                            Command="{x:Bind AddToLibraryCommand}"
                                                            Style="{StaticResource HoverIconButtonStyle}">
                                                            <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xE710;" />
                                                        </Button>
                                                    </Grid>
                                                </Grid>
                                            </StackPanel>
                                        </components:ShadowButton>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </StackPanel>
                </DataTemplate>
            </selectors:SectionDataTemplateSelector.UniformGridSectionTemplate>
        </selectors:SectionDataTemplateSelector>
    </Page.Resources>

    <Grid>
        <!--  Error State View  -->
        <controls:ErrorStateView
            Title="{x:Bind ViewModel.ErrorTitle, Mode=OneWay}"
            Details="{x:Bind ViewModel.ErrorDetails, Mode=OneWay}"
            Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
            RetryCommand="{x:Bind ViewModel.LoadDataCommand}"
            Visibility="{x:Bind ViewModel.HasError, Mode=OneWay}" />

        <!--  Normal Content  -->
        <ScrollViewer Visibility="{x:Bind ViewModel.HasError, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <StackPanel Padding="24,16" Spacing="32">
                <!--  Greeting Shimmer (shown when loading)  -->
                <labs:Shimmer
                    Width="250"
                    Height="38"
                    HorizontalAlignment="Left"
                    IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                    Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}" />

                <!--  Greeting  -->
                <TextBlock
                    FontSize="32"
                    FontWeight="Bold"
                    Text="{x:Bind ViewModel.Greeting, Mode=OneWay}"
                    Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}" />

                <!--  Loading Shimmer Cards  -->
                <ItemsRepeater ItemsSource="{x:Bind ViewModel.ShimmerItems}" Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}">
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="0,0,0,24" Spacing="16">
                                <!--  Section Header Shimmer  -->
                                <labs:Shimmer
                                    Width="200"
                                    Height="28"
                                    HorizontalAlignment="Left"
                                    IsActive="True" />

                                <!--  Content Cards Shimmer  -->
                                <ItemsRepeater ItemsSource="{Binding}">
                                    <ItemsRepeater.Layout>
                                        <StackLayout Orientation="Horizontal" Spacing="12" />
                                    </ItemsRepeater.Layout>
                                    <ItemsRepeater.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel
                                                Width="180"
                                                Padding="12"
                                                Spacing="8">
                                                <!--  Image Shimmer  -->
                                                <labs:Shimmer
                                                    Width="156"
                                                    Height="156"
                                                    CornerRadius="4"
                                                    IsActive="True" />

                                                <!--  Title Shimmer  -->
                                                <labs:Shimmer
                                                    Width="140"
                                                    Height="20"
                                                    IsActive="True" />

                                                <!--  Subtitle Shimmer  -->
                                                <labs:Shimmer
                                                    Width="100"
                                                    Height="16"
                                                    IsActive="True" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsRepeater.ItemTemplate>
                                </ItemsRepeater>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>

                <!--  Sections  -->
                <ItemsRepeater ItemTemplate="{StaticResource SectionTemplateSelector}" ItemsSource="{x:Bind ViewModel.Sections, Mode=OneWay}" />
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
